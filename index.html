<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Äî –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px; color: #1a202c;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    header { background: rgba(255,255,255,.95); border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 20px 40px rgba(0,0,0,.1); }
    h1 { font-size: 2.4rem; margin-bottom: 10px; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .subtitle { color: #718096; }
    .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
    .panel { background: rgba(255,255,255,.95); border-radius: 20px; padding: 26px; box-shadow: 0 20px 40px rgba(0,0,0,.1); }
    .panel h2 { color: #2d3748; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #e2e8f0; }
    .control-group { margin-bottom: 16px; }
    .control-group label { display: block; color: #4a5568; margin-bottom: 8px; font-weight: 600; }
    .control-group input, .control-group select, .control-group textarea { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 15px; transition: all .3s; background: #fff; }
    .control-group input:focus, .control-group select:focus, .control-group textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,.1); }
    .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; padding: 12px 22px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all .25s; box-shadow: 0 4px 15px rgba(102,126,234,.3); }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(102,126,234,.4); }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .btn-secondary { background: #718096; box-shadow: 0 4px 15px rgba(113,128,150,.3); }
    .push-preview { background: #f7fafc; border-radius: 15px; padding: 16px; margin-top: 12px; border: 2px solid #e2e8f0; min-height: 110px; }
    .push-preview .app-name { color: #718096; font-size: 12px; margin-bottom: 6px; }
    .push-preview .push-text { color: #2d3748; font-size: 14px; line-height: 1.5; }
    .stats-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; margin: 14px 0; }
    .stat-card { background: #f7fafc; padding: 14px; border-radius: 12px; text-align: center; border: 1px solid #edf2f7; }
    .stat-card .value { font-size: 22px; font-weight: 700; color: #667eea; }
    .stat-card .label { font-size: 12px; color: #718096; margin-top: 4px; }
    .category-list { background: #f7fafc; border-radius: 10px; padding: 12px; margin-top: 8px; max-height: 210px; overflow-y: auto; border: 1px solid #edf2f7; }
    .category-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e2e8f0; }
    .category-item:last-child { border-bottom: none; }
    .category-item .name { color: #4a5568; font-weight: 500; }
    .category-item .amount { color: #667eea; font-weight: 600; }
    .results-table { width: 100%; margin-top: 14px; border-collapse: collapse; }
    .results-table th, .results-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; vertical-align: top; }
    .results-table th { background: #f7fafc; font-weight: 600; color: #4a5568; position: sticky; top: 0; }
    .results-table tr:hover { background: #f9fbff; }
    .product-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
    .progress-bar { background: #e2e8f0; border-radius: 10px; height: 10px; overflow: hidden; margin: 12px 0; }
    .progress-fill { height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; width: 0%; transition: width .5s ease; }
    .checklist { background: #f7fafc; border-radius: 12px; padding: 16px; margin-top: 10px; border: 1px solid #edf2f7; }
    .checklist-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid #e2e8f0; }
    .checklist-item:last-child { border-bottom: none; }
    .check { width: 22px; height: 22px; border-radius: 50%; background: #48bb78; color: #fff; display: grid; place-items: center; font-weight: 700; }
    .loading { display: none; text-align: center; padding: 14px; color: #718096; }
    .loading.show { display: block; }
    .spinner { border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; width: 34px; height: 34px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    @media (max-width: 900px) { .main-content { grid-template-columns: 1fr; } h1 { font-size: 1.9rem; } }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>üöÄ –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h1>
      <p class="subtitle">–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –ø–æ–¥–±–æ—Ä –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</p>
    </header>

    <div class="main-content">
      <div class="panel">
        <h2>üìä –ê–Ω–∞–ª–∏–∑ –∫–ª–∏–µ–Ω—Ç–∞</h2>
        <div class="control-group">
          <label for="clientSelect">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞:</label>
          <select id="clientSelect" onchange="loadClientData()">
            <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ ‚Äî</option>
          </select>
        </div>
        <div class="control-group">
          <label for="clientName">–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞:</label>
          <input type="text" id="clientName" readonly style="background:#f7fafc" />
        </div>
        <div class="control-group">
          <label for="clientStatus">–°—Ç–∞—Ç—É—Å:</label>
          <input type="text" id="clientStatus" readonly style="background:#f7fafc" />
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap: 12px;">
          <div class="control-group">
            <label for="clientAge">–í–æ–∑—Ä–∞—Å—Ç:</label>
            <input type="number" id="clientAge" readonly style="background:#f7fafc" />
          </div>
          <div class="control-group">
            <label for="clientCity">–ì–æ—Ä–æ–¥:</label>
            <input type="text" id="clientCity" readonly style="background:#f7fafc" />
          </div>
        </div>
        <div class="control-group">
          <label for="avgBalance">–°—Ä–µ–¥–Ω–∏–π –æ—Å—Ç–∞—Ç–æ–∫ (‚Ç∏):</label>
          <input type="text" id="avgBalance" readonly style="background:#f7fafc" />
        </div>
        <div class="control-group">
          <label>–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç—Ä–∞—Ç (–∑–∞ 3 –º–µ—Å—è—Ü–∞):</label>
          <div class="category-list" id="categoryList">
            <div class="loading"><p style="color:#718096">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p></div>
          </div>
        </div>
        <button class="btn" onclick="analyzeClient()" id="analyzeBtn" disabled>üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ–¥–æ–±—Ä–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç</button>
      </div>

      <div class="panel">
        <h2>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø—Ä–æ–¥—É–∫—Ç–∞</h2>
        <div class="stats-grid">
          <div class="stat-card"><div class="value" id="potentialCashback">0 ‚Ç∏</div><div class="label">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π –∫–µ—à–±—ç–∫</div></div>
          <div class="stat-card"><div class="value" id="monthlyBenefit">0 ‚Ç∏</div><div class="label">–ï–∂–µ–º–µ—Å—è—á–Ω–∞—è –≤—ã–≥–æ–¥–∞</div></div>
          <div class="stat-card"><div class="value" id="matchScore">0%</div><div class="label">–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ</div></div>
        </div>
        <div class="control-group">
          <label for="recommendedProduct">–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç:</label>
          <input type="text" id="recommendedProduct" readonly style="background:#f7fafc" />
        </div>
        <div class="control-group">
          <label for="reasonText">–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞:</label>
          <textarea id="reasonText" rows="3" readonly style="background:#f7fafc"></textarea>
        </div>
        <h3 style="margin: 10px 0 6px">üì± –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</h3>
        <div class="push-preview"><div class="app-name">–ë–∞–Ω–∫ ‚Ä¢ —Å–µ–π—á–∞—Å</div><div class="push-text" id="pushPreview">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞</div></div>
        <div style="margin-top: 16px; display:flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn" onclick="generateAllPushes()">üìã –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</button>
          <button class="btn btn-secondary" onclick="downloadCSV()" id="downloadBtn" disabled>üíæ –°–∫–∞—á–∞—Ç—å CSV</button>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¢–ó</h2>
      <div class="checklist">
        <div class="checklist-item"><div class="check">‚úì</div><div>–ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ –¥–∞–Ω–Ω—ã–º –∑–∞ 3 –º–µ—Å—è—Ü–∞ –∏–∑ —Ñ–∞–π–ª–æ–≤ –≤ /data</div></div>
        <div class="checklist-item"><div class="check">‚úì</div><div>–í—ã—á–∏—Å–ª–µ–Ω–∏–µ –æ–∂–∏–¥–∞–µ–º–æ–π –≤—ã–≥–æ–¥—ã –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—Ä–æ–¥—É–∫—Ç—É</div></div>
        <div class="checklist-item"><div class="check">‚úì</div><div>–í—ã–±–æ—Ä —Å–∞–º–æ–≥–æ –ø–æ–ª–µ–∑–Ω–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∞—Ç –∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤</div></div>
        <div class="checklist-item"><div class="check">‚úì</div><div>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—É—à–µ–π (180‚Äì220 —Å–∏–º–≤–æ–ª–æ–≤, TOV)</div></div>
        <div class="checklist-item"><div class="check">‚úì</div><div>–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV: client_code,product,push_notification</div></div>
        <div class="checklist-item"><div class="check">‚úì</div><div>–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö 60 –∫–ª–∏–µ–Ω—Ç–æ–≤</div></div>
      </div>
    </div>

    <div class="panel">
      <h2>üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
      <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
      <p id="progressText">–ì–æ—Ç–æ–≤–æ –∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</p>
      <div class="loading" id="loadingIndicator"><div class="spinner"></div><p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–æ–≤‚Ä¶</p></div>
      <table class="results-table" id="resultsTable" style="display:none">
        <thead><tr><th>–ö–æ–¥</th><th>–ò–º—è</th><th>–ü—Ä–æ–¥—É–∫—Ç</th><th>–ü—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</th></tr></thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // === –ü–£–¢–ò –ö –§–ê–ô–õ–ê–ú ===
    const DATA_DIR = 'data';
    const CLIENTS_FILE = `${DATA_DIR}/clients.csv`;

    // === –ì–õ–û–ë–ê–õ–¨–ù–û ===
    let clientsData = [];
    let currentClientData = null;
    let allResults = [];

    // === –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø CSV ===
    const HEADER_MAP = new Map([
      // –∫–ª–∏–µ–Ω—Ç—ã
      ['client_code','client_code'], ['–∫–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞','client_code'], ['client code','client_code'], ['code','client_code'], ['id','client_code'],
      ['name','name'], ['–∏–º—è','name'],
      ['status','status'], ['—Å—Ç–∞—Ç—É—Å','status'],
      ['age','age'], ['–≤–æ–∑—Ä–∞—Å—Ç','age'],
      ['city','city'], ['–≥–æ—Ä–æ–¥','city'],
      ['avg_monthly_balance_kzt','avg_monthly_balance_KZT'],
      ['avg_monthly_balance','avg_monthly_balance_KZT'],
      ['avg_balance','avg_monthly_balance_KZT'],
      ['—Å—Ä–µ–¥–Ω–∏–π –æ—Å—Ç–∞—Ç–æ–∫','avg_monthly_balance_KZT'],
      // —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏/–ø–µ—Ä–µ–≤–æ–¥—ã
      ['category','category'], ['–∫–∞—Ç–µ–≥–æ—Ä–∏—è','category'],
      ['amount','amount'], ['—Å—É–º–º–∞','amount'], ['amt','amount'], ['value','amount'],
      ['direction','direction'], ['–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ','direction'],
      ['type','type'], ['—Ç–∏–ø','type'],
      ['currency','currency']
    ]);
    function stripBOM(s){ return typeof s==='string' ? s.replace(/^\uFEFF/,'') : s; }
    function normalizeKey(header){
      const clean = stripBOM(String(header)).trim().replace(/\s+/g,' ').toLowerCase();
      return HEADER_MAP.get(clean) ?? stripBOM(String(header)).trim();
    }
    function toNumber(val){
      if (typeof val==='number' && Number.isFinite(val)) return val;
      const s = String(val ?? '').replace(/\u00A0/g,' ') // NBSP -> space
                                 .replace(/\s+/g,'')     // remove spaces/thin spaces
                                 .replace(',', '.');      // comma -> dot
      const n = Number(s);
      return Number.isFinite(n) ? n : 0;
    }
    function postProcessRow(row){
      if ('client_code' in row) row.client_code = toNumber(row.client_code);
      if ('age' in row) row.age = toNumber(row.age);
      if ('avg_monthly_balance_KZT' in row) row.avg_monthly_balance_KZT = toNumber(row.avg_monthly_balance_KZT);
      if ('amount' in row) row.amount = toNumber(row.amount);
      return row;
    }
    async function fetchCsv(url){
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status} –¥–ª—è ${url}`);
      const text = await res.text();
      const parsed = Papa.parse(text, { header: true, dynamicTyping: false, skipEmptyLines: true, transformHeader: normalizeKey });
      return parsed.data.map(postProcessRow);
    }

    // === –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –ß–ò–°–ï–õ ===
    function formatMoneyKZT(value){
      // —Ä–∞–∑—Ä—è–¥—ã ‚Äî –ø—Ä–æ–±–µ–ª; –¥–µ—Å—è—Ç–∏—á–Ω–∞—è –∑–∞–ø—è—Ç–∞—è; –∑–Ω–∞–∫ –≤–∞–ª—é—Ç—ã —Å –ø—Ä–æ–±–µ–ª–æ–º
      const n = Math.round(toNumber(value));
      return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' ‚Ç∏';
    }
    function formatNumberSpaced(n){
      return Math.round(toNumber(n)).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }

    // === –ó–ê–ì–†–£–ó–ö–ê –ö–õ–ò–ï–ù–¢–û–í ===
    async function loadClientsData(){
      clientsData = await fetchCsv(CLIENTS_FILE);
      clientsData = clientsData.filter(c => c && c.client_code);
      const select = document.getElementById('clientSelect');
      for (const client of clientsData){
        const opt = document.createElement('option');
        opt.value = client.client_code;
        opt.textContent = `${client.client_code}. ${client.name ?? '–ë–µ–∑ –∏–º–µ–Ω–∏'} (${client.status ?? '–°—Ç–∞—Ç—É—Å –Ω–µ —É–∫–∞–∑–∞–Ω'})`;
        select.appendChild(opt);
      }
    }

    // === –ó–ê–ì–†–£–ó–ö–ê –û–î–ù–û–ì–û –ö–õ–ò–ï–ù–¢–ê ===
    async function loadClientData(){
      const clientCode = document.getElementById('clientSelect').value;
      if (!clientCode) return;
      const client = clientsData.find(c => String(c.client_code) === String(clientCode));
      if (!client) return;
      document.getElementById('clientName').value = client.name ?? '';
      document.getElementById('clientStatus').value = client.status ?? '';
      document.getElementById('clientAge').value = client.age ?? '';
      document.getElementById('clientCity').value = client.city ?? '';
      document.getElementById('avgBalance').value = formatNumberSpaced(client.avg_monthly_balance_KZT ?? 0);

      const categoryList = document.getElementById('categoryList');
      categoryList.innerHTML = '<div class="loading show"><div class="spinner"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π‚Ä¶</p></div>';

      try {
        const [transactions, transfers] = await Promise.all([
          loadClientTransactions(client.client_code),
          loadClientTransfers(client.client_code)
        ]);
        const analysis = analyzeClientBehavior(transactions, transfers, client);
        currentClientData = { client, transactions, transfers, analysis };
        displayTopCategories(analysis.topCategories);
        document.getElementById('analyzeBtn').disabled = false;
      } catch (e){
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞', e);
        categoryList.innerHTML = '<p style="color:#a0aec0;text-align:center">–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è CSV. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ /data</p>';
        document.getElementById('analyzeBtn').disabled = true;
      }
    }

    async function loadClientTransactions(code){
      const url = `${DATA_DIR}/client_${code}_transactions_3m.csv`;
      const data = await fetchCsv(url);
      return data.filter(r => r.category && Number.isFinite(r.amount));
    }
    async function loadClientTransfers(code){
      const url = `${DATA_DIR}/client_${code}_transfers_3m.csv`;
      const raw = await fetchCsv(url);
      return raw.map(r => ({
        direction: (r.direction ?? '').toString().toLowerCase(),
        type: (r.type ?? '').toString().toLowerCase(),
        amount: toNumber(r.amount),
        currency: r.currency ?? 'KZT'
      })).filter(r => r.direction && Number.isFinite(r.amount));
    }

    // === –ê–ù–ê–õ–ò–¢–ò–ö–ê ===
    function analyzeClientBehavior(transactions, transfers, client){
      // –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
      const categorySpending = {};
      let totalSpending = 0;
      let latestTxDate = null;
      transactions.forEach(t => {
        const cat = t.category;
        const amt = toNumber(t.amount);
        if (!cat || !amt) return;
        if (!categorySpending[cat]) categorySpending[cat] = { count: 0, total: 0 };
        categorySpending[cat].count += 1;
        categorySpending[cat].total += amt;
        totalSpending += amt;
        if (t.date){ const d = new Date(t.date); if (!isNaN(d)) latestTxDate = (!latestTxDate || d > latestTxDate) ? d : latestTxDate; }
      });
      const topCategories = Object.entries(categorySpending)
        .sort((a,b) => b[1].total - a[1].total)
        .slice(0, 10)
        .map(([name, data]) => ({ name, amount: data.total, count: data.count, percentage: totalSpending ? ((data.total/totalSpending*100).toFixed(1)) : '0.0' }));

      const transferAgg = {
        totalIncoming: 0, totalOutgoing: 0,
        hasSalary: false, hasStipend: false,
        hasForex: false, hasInvest: false, hasLoans: false,
        atmWithdrawals: 0, p2pTransfers: 0, utilities: 0
      };
      transfers.forEach(t => {
        const amt = toNumber(t.amount);
        if (t.direction === 'in') {
          transferAgg.totalIncoming += amt;
          if (t.type === 'salary_in') transferAgg.hasSalary = true;
          if (t.type === 'stipend_in') transferAgg.hasStipend = true;
        } else if (t.direction === 'out') {
          transferAgg.totalOutgoing += amt;
          if (t.type === 'atm_withdrawal') transferAgg.atmWithdrawals += amt;
          if (t.type === 'p2p_out' || t.type === 'card_out') transferAgg.p2pTransfers += amt;
          if (t.type === 'utilities_out') transferAgg.utilities += amt;
          if (['fx_buy','fx_sell'].includes(t.type)) transferAgg.hasForex = true;
          if (t.type === 'invest_out' || t.type === 'gold_buy_out') transferAgg.hasInvest = true;
          if (t.type === 'loan_payment_out' || t.type === 'cc_repayment_out' || t.type === 'installment_payment_out') transferAgg.hasLoans = true;
        }
      });

      // –ø—Ä–∏–∑–Ω–∞–∫–∏ —á–∞—Å—Ç—ã—Ö –ø–æ–µ–∑–¥–æ–∫/—Ç–∞–∫—Å–∏
      const TRAVEL_CATS = ['–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è', '–¢–∞–∫—Å–∏', '–û—Ç–µ–ª–∏', '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç'];
      const travelSpending = topCategories.filter(c => TRAVEL_CATS.includes(c.name)).reduce((s,c)=>s+c.amount,0);

      // –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ —Ç—Ä–∞—Ç—ã
      const PREMIUM_CATS = ['–Æ–≤–µ–ª–∏—Ä–Ω—ã–µ —É–∫—Ä–∞—à–µ–Ω–∏—è', '–ö–æ—Å–º–µ—Ç–∏–∫–∞ –∏ –ü–∞—Ä—Ñ—é–º–µ—Ä–∏—è', '–†–µ—Å—Ç–æ—Ä–∞–Ω—ã', '–ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã'];
      const premiumSpending = topCategories.filter(c => PREMIUM_CATS.includes(c.name)).reduce((s,c)=>s+c.amount,0);

      // –æ–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å—ã (–¥–ª—è –∫—Ä–µ–¥–∏—Ç–∫–∏ 10%)
      const ONLINE_CATS = ['–°–º–æ—Ç—Ä–∏–º –¥–æ–º–∞','–ï–¥–∏–º –¥–æ–º–∞','–ò–≥—Ä–∞–µ–º –¥–æ–º–∞','–î–æ—Å—Ç–∞–≤–∫–∞','–û–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å—ã','–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è','–ö–∏–Ω–æ'];
      const onlineSpending = topCategories.filter(c => ONLINE_CATS.includes(c.name)).reduce((s,c)=>s+c.amount,0);

      return {
        topCategories,
        totalSpending,
        monthlySpending: totalSpending/3,
        transferAgg,
        balance: toNumber(client.avg_monthly_balance_KZT),
        travelSpending,
        premiumSpending,
        onlineSpending,
        latestTxDate
      };
    }

    function displayTopCategories(categories){
      const el = document.getElementById('categoryList');
      if (!categories || !categories.length){ el.innerHTML = '<p style="color:#718096;text-align:center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö</p>'; return; }
      el.innerHTML = categories.slice(0,5).map(cat => (
        `<div class="category-item"><div class="name">${cat.name} (${cat.percentage}%)</div><div class="amount">${formatNumberSpaced(cat.amount)} ‚Ç∏</div></div>`
      )).join('');
    }

    // === –û–¶–ï–ù–ö–ê –ü–†–û–î–£–ö–¢–û–í ===
    function selectBestProduct(client, a){
      const products = [];
      const age = toNumber(client.age);
      const bal = toNumber(client.avg_monthly_balance_KZT);

      // 1) –ö–∞—Ä—Ç–∞ –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π ‚Äî 4% –Ω–∞ –ø–æ–µ–∑–¥–∫–∏/—Ç–∞–∫—Å–∏/–æ—Ç–µ–ª–∏/—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
      if (a.travelSpending > 50000) {
        const monthlyTravel = a.travelSpending/3;
        const monthlyCashback = monthlyTravel * 0.04;
        products.push({
          key:'travel', product:'–ö–∞—Ä—Ç–∞ –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π', score: 80 + Math.min(20, a.travelSpending/50000*5),
          cashback: monthlyCashback, monthlyBenefit: monthlyCashback, matchScore: Math.min(95, 80 + a.travelSpending/10000),
          reason: `–ú–Ω–æ–≥–æ –ø–æ–µ–∑–¥–æ–∫ –∏ —Ç–∞–∫—Å–∏ ‚Äî ${formatNumberSpaced(Math.round(monthlyTravel))} ‚Ç∏/–º–µ—Å. –ö–µ—à–±—ç–∫ 4% –Ω–∞ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç.`
        });
      }

      // 2) –ü—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Äî 2% –±–∞–∑–æ–≤—ã–π; 3% –ø—Ä–∏ –¥–µ–ø–æ–∑–∏—Ç–µ 1‚Äì6 –º–ª–Ω; 4% –ø—Ä–∏ –¥–µ–ø–æ–∑–∏—Ç–µ ‚â•6 –º–ª–Ω; –ª–∏–º–∏—Ç 100 000 ‚Ç∏/–º–µ—Å; –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π 4% –Ω–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã/—é–≤–µ–ª–∏—Ä–∫—É/–ø–∞—Ä—Ñ—é–º–µ—Ä–∏—é
      if (bal > 500000 || a.premiumSpending > 100000) {
        const rate = bal >= 6000000 ? 0.04 : bal >= 1000000 ? 0.03 : 0.02;
        const monthlyCashback = Math.min(100000, a.monthlySpending * rate);
        products.push({
          key:'premium', product:'–ü—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞', score: 85 + Math.min(15, bal/500000),
          cashback: monthlyCashback, monthlyBenefit: monthlyCashback, matchScore: Math.min(95, 85 + bal/500000),
          reason: `–ö—Ä—É–ø–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ ${formatNumberSpaced(bal)} ‚Ç∏ –∏ –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ —Ç—Ä–∞—Ç—ã. –ö–µ—à–±—ç–∫ ${Math.round(rate*100)}% (–ª–∏–º–∏—Ç 100 000 ‚Ç∏/–º–µ—Å).`
        });
      }

      // 3) –ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Äî –¥–æ 10% –≤ –ª—é–±–∏–º—ã—Ö 3 –∫–∞—Ç. + 10% –æ–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å—ã, —Ä–∞—Å—Å—Ä–æ—á–∫–∞
      if (a.topCategories.length >= 3) {
        const top3 = a.topCategories.slice(0,3);
        const avgTop3 = top3.reduce((s,c)=>s+c.amount,0)/3/3; // —Å—Ä–µ–¥–Ω–µ–µ –ø–æ 3 –º–µ—Å ‚Üí —Å—Ä–µ–¥–Ω–µ–µ –∑–∞ –º–µ—Å, –∑–∞—Ç–µ–º —Å—Ä–µ–¥–Ω–µ–µ –ø–æ —Ç–æ–ø-3
        const monthlyCashback = avgTop3 * 0.10 + (a.onlineSpending/3) * 0.10;
        products.push({
          key:'credit', product:'–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞', score: 70 + (age < 45 ? 10 : 0) + Math.min(10, a.onlineSpending/50000),
          cashback: monthlyCashback, monthlyBenefit: monthlyCashback, matchScore: Math.min(85, 70 + top3.length*3),
          reason: `–î–æ 10% –≤ –ª—é–±–∏–º—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö –∏ –Ω–∞ –æ–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å—ã. –†–∞—Å—Å—Ä–æ—á–∫–∞ 3‚Äì24 –º–µ—Å –±–µ–∑ –ø–µ—Ä–µ–ø–ª–∞—Ç.`
        });
      }

      // 4) FX / –º—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω—ã–µ
      if (a.transferAgg.hasForex) {
        products.push({
          key:'fx', product:'–û–±–º–µ–Ω –≤–∞–ª—é—Ç', score: 72 + Math.min(10, a.transferAgg.totalOutgoing/300000),
          cashback: 0, monthlyBenefit: 0, matchScore: 75,
          reason: '–ß–∞—Å—Ç—ã–µ –≤–∞–ª—é—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ‚Äî –≤—ã–≥–æ–¥–Ω—ã–π –∫—É—Ä—Å, –∞–≤—Ç–æ-–ø–æ–∫—É–ø–∫–∞ –ø–æ —Ü–µ–ª–µ–≤–æ–º—É.'
        });
      }

      // 5) –î–µ–ø–æ–∑–∏—Ç—ã
      if (bal >= 150000) {
        // Savings 16.5% ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π –∑–∞–ø–∞—Å
        const monthlyInterestSavings = bal * 0.165 / 12;
        products.push({ key:'dep_sav', product:'–î–µ–ø–æ–∑–∏—Ç –°–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω—ã–π', score: 70 + Math.min(20, bal/300000), cashback: 0, monthlyBenefit: monthlyInterestSavings, matchScore: 80, reason: `–î–æ—Ö–æ–¥ ${formatNumberSpaced(Math.round(monthlyInterestSavings))} ‚Ç∏/–º–µ—Å –ø—Ä–∏ —Å—Ç–∞–≤–∫–µ 16,5%.` });
        // Accumulative 15.5%
        const monthlyInterestAcc = bal * 0.155 / 12;
        products.push({ key:'dep_acc', product:'–î–µ–ø–æ–∑–∏—Ç –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π', score: 65 + Math.min(18, bal/350000), cashback: 0, monthlyBenefit: monthlyInterestAcc, matchScore: 75, reason: `–ü–æ–ø–æ–ª–Ω—è–µ–º—ã–π –≤–∫–ª–∞–¥, —Å—Ç–∞–≤–∫–∞ 15,5%.` });
        // Multicurrency 14.5%
        const monthlyInterestMulti = bal * 0.145 / 12;
        products.push({ key:'dep_multi', product:'–î–µ–ø–æ–∑–∏—Ç –ú—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω—ã–π', score: 62 + Math.min(15, bal/400000), cashback: 0, monthlyBenefit: monthlyInterestMulti, matchScore: 72, reason: `14,5% –∏ –≥–∏–±–∫–∏–π –¥–æ—Å—Ç—É–ø –∫ –≤–∞–ª—é—Ç–∞–º.` });
      }

      // 6) –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –∏ –≤–æ–∑—Ä–∞—Å—Ç < 55
      if (bal > 100000 && age < 55) {
        const potential = bal * 0.12 / 12;
        products.push({ key:'invest', product:'–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', score: 60 + Math.min(12, (55-age)), cashback: 0, monthlyBenefit: potential, matchScore: 70, reason: '0% –∫–æ–º–∏—Å—Å–∏–∏ –Ω–∞ —Å–¥–µ–ª–∫–∏, –Ω–∏–∑–∫–∏–π –ø–æ—Ä–æ–≥ –≤—Ö–æ–¥–∞.' });
      }

      // 7) –ö—Ä–µ–¥–∏—Ç –Ω–∞–ª–∏—á–Ω—ã–º–∏ ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ (–º–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º/–∫–æ–º–º—É–Ω–∞–ª–∫–µ –ø—Ä–∏ –Ω–µ–≤—ã—Å–æ–∫–æ–º –±–∞–ª–∞–Ω—Å–µ)
      if ((a.transferAgg.hasLoans || a.transferAgg.utilities > 80000) && bal < 250000) {
        products.push({ key:'cash_loan', product:'–ö—Ä–µ–¥–∏—Ç –Ω–∞–ª–∏—á–Ω—ã–º–∏', score: 58 + Math.min(10, a.transferAgg.utilities/50000), cashback: 0, monthlyBenefit: 0, matchScore: 68, reason: '–ë—ã—Å—Ç—Ä–æ–µ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑ –∑–∞–ª–æ–≥–∞, –≥–∏–±–∫–∏–µ –≤—ã–ø–ª–∞—Ç—ã.' });
      }

      if (!products.length){
        // –¥–µ—Ñ–æ–ª—Ç ‚Äî –º—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç
        return { product:'–î–µ–ø–æ–∑–∏—Ç –ú—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω—ã–π', cashback:0, monthlyBenefit: bal*0.145/12, matchScore: 60, reason: '–°—Ç–∞–±–∏–ª—å–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –∏ –≥–∏–±–∫–∏–π –¥–æ—Å—Ç—É–ø –∫ –≤–∞–ª—é—Ç–∞–º.' };
      }

      products.sort((a,b)=> b.score - a.score);
      return products[0];
    }

    // === –ü–£–®-–¢–ï–ö–°–¢–´ –° –£–ß–Å–¢–û–ú –í–û–ó–†–ê–°–¢–ê/TOV ===
    const MONTHS_RU = ['—è–Ω–≤–∞—Ä–µ','—Ñ–µ–≤—Ä–∞–ª–µ','–º–∞—Ä—Ç–µ','–∞–ø—Ä–µ–ª–µ','–º–∞–µ','–∏—é–Ω–µ','–∏—é–ª–µ','–∞–≤–≥—É—Å—Ç–µ','—Å–µ–Ω—Ç—è–±—Ä–µ','–æ–∫—Ç—è–±—Ä–µ','–Ω–æ—è–±—Ä–µ','–¥–µ–∫–∞–±—Ä–µ'];
    function monthFromDate(d){ if (!d) return '—ç—Ç–æ–º –º–µ—Å—è—Ü–µ'; const m = d.getMonth(); return ` ${MONTHS_RU[m]}`; }

    function toneByAge(age){
      if (age <= 24) return { emoji:'üôÇ', humor: 1, formal: false };
      if (age <= 45) return { emoji:'', humor: 1, formal: false };
      return { emoji:'', humor: 0, formal: true };
    }

    function clampPush(text){
      // —Ü–µ–ª—å 180‚Äì220 —Å–∏–º–≤–æ–ª–æ–≤
      if (text.length > 220) return text.slice(0,217) + '‚Ä¶';
      if (text.length < 160) return text; // –Ω–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ
      return text;
    }

    function generatePush(client, rec, a){
      const name = client.name || '–ö–ª–∏–µ–Ω—Ç';
      const age = toNumber(client.age);
      const tone = toneByAge(age);
      const monthWord = monthFromDate(a.latestTxDate);

      const cats = a.topCategories.map(c => c.name);
      const top3 = cats.slice(0,3).join(', ');

      let text = '';
      switch (rec.product){
        case '–ö–∞—Ä—Ç–∞ –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π': {
          const monthlyTravel = Math.round(a.travelSpending/3);
          const cb = Math.round(monthlyTravel * 0.04);
          text = `${name}, –≤${monthWord} —É –≤–∞—Å –º–Ω–æ–≥–æ –ø–æ–µ–∑–¥–æ–∫ –∏ —Ç–∞–∫—Å–∏ ‚Äî ${formatNumberSpaced(monthlyTravel)} ‚Ç∏. –° —Ç—Ä–µ–≤–µ–ª‚Äë–∫–∞—Ä—Ç–æ–π –≤–µ—Ä–Ω—É–ª–∏ –±—ã ‚âà${formatNumberSpaced(cb)} ‚Ç∏ –∫–µ—à–±—ç–∫–æ–º. –û—Ñ–æ—Ä–º–∏—Ç—å –∫–∞—Ä—Ç—É?`;
          break;
        }
        case '–ü—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞': {
          const rate = (toNumber(client.avg_monthly_balance_KZT) >= 6000000) ? 4 : (toNumber(client.avg_monthly_balance_KZT) >= 1000000 ? 3 : 2);
          text = `${name}, —É –≤–∞—Å —Å—Ç–∞–±–∏–ª—å–Ω–æ –∫—Ä—É–ø–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –∏ –∑–∞–º–µ—Ç–Ω—ã–µ —Ç—Ä–∞—Ç—ã –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞—Ö. –ü—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –¥–∞—Å—Ç ${rate}% –∫–µ—à–±—ç–∫–∞ (–ª–∏–º–∏—Ç 100 000 ‚Ç∏/–º–µ—Å) –∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Å–Ω—è—Ç–∏—è. –û—Ñ–æ—Ä–º–∏—Ç—å —Å–µ–π—á–∞—Å.`;
          break;
        }
        case '–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞': {
          text = `${name}, –≤–∞—à–∏ —Ç–æ–ø‚Äë–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî ${top3}. –ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ –¥–∞—ë—Ç –¥–æ 10% –≤ –ª—é–±–∏–º—ã—Ö –∏ –Ω–∞ –æ–Ω–ª–∞–π–Ω‚Äë—Å–µ—Ä–≤–∏—Å—ã, –ø–ª—é—Å —Ä–∞—Å—Å—Ä–æ—á–∫–∞ 3‚Äì24 –º–µ—Å. –û—Ñ–æ—Ä–º–∏—Ç—å –∫–∞—Ä—Ç—É.`;
          break;
        }
        case '–û–±–º–µ–Ω –≤–∞–ª—é—Ç': {
          text = `${name}, –≤—ã —á–∞—Å—Ç–æ –ø—Ä–æ–≤–æ–¥–∏—Ç–µ –≤–∞–ª—é—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏. –í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ ‚Äî –≤—ã–≥–æ–¥–Ω—ã–π –æ–±–º–µ–Ω –±–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏ –∏ –∞–≤—Ç–æ‚Äë–ø–æ–∫—É–ø–∫–∞ –ø–æ —Ü–µ–ª–µ–≤–æ–º—É –∫—É—Ä—Å—É. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±–º–µ–Ω.`;
          break;
        }
        case '–î–µ–ø–æ–∑–∏—Ç –°–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω—ã–π': {
          const monthly = Math.round(toNumber(client.avg_monthly_balance_KZT)*0.165/12);
          text = `${name}, —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –º–æ–∂–Ω–æ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –Ω–∞ —Å–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω–æ–º –≤–∫–ª–∞–¥–µ –ø–æ–¥ 16,5% –≥–æ–¥–æ–≤—ã—Ö. –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥ ‚Äî –æ–∫–æ–ª–æ ${formatNumberSpaced(monthly)} ‚Ç∏. –û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥.`;
          break;
        }
        case '–î–µ–ø–æ–∑–∏—Ç –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π': {
          text = `${name}, —É–¥–æ–±–Ω–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –∏ –Ω–µ —Ç—Ä–∞—Ç–∏—Ç—å: –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π –≤–∫–ª–∞–¥ –ø–æ–¥ 15,5% —Å –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è–º–∏. –û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥.`;
          break;
        }
        case '–î–µ–ø–æ–∑–∏—Ç –ú—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω—ã–π': {
          text = `${name}, –º—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω—ã–π –≤–∫–ª–∞–¥ 14,5% ‚Äî —Ö—Ä–∞–Ω–∏—Ç—å –∏ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å –≤–∞–ª—é—Ç—ã —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –¥–µ–Ω—å–≥–∞–º. –û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥.`;
          break;
        }
        case '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏': {
          text = `${name}, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: 0% –∫–æ–º–∏—Å—Å–∏–∏ –Ω–∞ —Å–¥–µ–ª–∫–∏ –∏ –Ω–∏–∑–∫–∏–π –ø–æ—Ä–æ–≥ –≤—Ö–æ–¥–∞ ‚Äî —É–¥–æ–±–Ω–æ –Ω–∞—á–∞—Ç—å —Å –Ω–µ–±–æ–ª—å—à–æ–π —Å—É–º–º—ã. –û—Ç–∫—Ä—ã—Ç—å —Å—á—ë—Ç.`;
          break;
        }
        case '–ö—Ä–µ–¥–∏—Ç –Ω–∞–ª–∏—á–Ω—ã–º–∏': {
          text = `${name}, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –∑–∞–ø–∞—Å –Ω–∞ –∫—Ä—É–ø–Ω—ã–µ —Ç—Ä–∞—Ç—ã ‚Äî –º–æ–∂–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –∫—Ä–µ–¥–∏—Ç –Ω–∞–ª–∏—á–Ω—ã–º–∏ –±–µ–∑ –∑–∞–ª–æ–≥–∞ –∏ —Å –≥–∏–±–∫–∏–º–∏ –≤—ã–ø–ª–∞—Ç–∞–º–∏. –£–∑–Ω–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–π –ª–∏–º–∏—Ç.`;
          break;
        }
        default: {
          text = `${name}, –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å –Ω–∞—à–∏–º–∏ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ ‚Äî –ø–æ–¥–±–µ—Ä—ë–º –ø–æ–¥ –≤–∞—à–∏ –ø—Ä–∏–≤—ã—á–∫–∏. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã.`;
        }
      }

      // TOV –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏
      if (tone.humor && rec.product !== '–ö—Ä–µ–¥–∏—Ç –Ω–∞–ª–∏—á–Ω—ã–º–∏') {
        text = text.replace(/\.$/, '') + (tone.emoji ? ` ${tone.emoji}` : '');
      }
      return clampPush(text);
    }

    // === –ê–ù–ê–õ–ò–ó –ò –û–¢–†–ò–°–û–í–ö–ê –î–õ–Ø –û–î–ù–û–ì–û –ö–õ–ò–ï–ù–¢–ê ===
    function analyzeClient(){
      if (!currentClientData) return;
      const { client, analysis } = currentClientData;
      const rec = selectBestProduct(client, analysis);
      const push = generatePush(client, rec, analysis);
      document.getElementById('recommendedProduct').value = rec.product;
      document.getElementById('reasonText').value = rec.reason;
      document.getElementById('pushPreview').textContent = push;
      document.getElementById('potentialCashback').textContent = formatMoneyKZT(rec.cashback || 0);
      document.getElementById('monthlyBenefit').textContent = formatMoneyKZT(rec.monthlyBenefit || 0);
      document.getElementById('matchScore').textContent = (rec.matchScore || 0) + '%';
    }

    // === –ì–ï–ù–ï–†–ê–¶–ò–Ø –î–õ–Ø –í–°–ï–• ===
    async function generateAllPushes(){
      allResults = [];
      const body = document.getElementById('resultsBody');
      body.innerHTML = '';
      document.getElementById('loadingIndicator').classList.add('show');
      document.getElementById('resultsTable').style.display = 'none';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('progressText').textContent = '–ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∞–ª–∏–∑‚Ä¶';

      let processed = 0;
      for (const client of clientsData){
        try{
          const [tx, tr] = await Promise.all([
            loadClientTransactions(client.client_code),
            loadClientTransfers(client.client_code)
          ]);
          const analysis = analyzeClientBehavior(tx, tr, client);
          const rec = selectBestProduct(client, analysis);
          const push = generatePush(client, rec, analysis);
          allResults.push({ client_code: client.client_code, product: rec.product, push_notification: push });
          const row = document.createElement('tr');
          row.innerHTML = `<td>${client.client_code}</td><td>${client.name}</td><td><span class="product-badge">${rec.product}</span></td><td style="max-width:520px; font-size:13px; line-height:1.35">${push}</td>`;
          body.appendChild(row);
        } catch(e){
          console.error(`–û—à–∏–±–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ ${client.client_code}`, e);
        }
        processed++;
        document.getElementById('progressBar').style.width = (processed/clientsData.length*100) + '%';
        document.getElementById('progressText').textContent = `–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${processed} –∏–∑ ${clientsData.length} –∫–ª–∏–µ–Ω—Ç–æ–≤`;
        await new Promise(r=>setTimeout(r, 20));
      }

      document.getElementById('loadingIndicator').classList.remove('show');
      document.getElementById('resultsTable').style.display = 'table';
      document.getElementById('downloadBtn').disabled = false;
      document.getElementById('progressText').textContent = `‚úÖ –í—Å–µ ${clientsData.length} –∫–ª–∏–µ–Ω—Ç–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã!`;
      alert(`‚úÖ –ì–æ—Ç–æ–≤–æ! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${clientsData.length} –∫–ª–∏–µ–Ω—Ç–æ–≤.`);
    }

    // === –í–´–ì–†–£–ó–ö–ê CSV ===
    function downloadCSV(){
      if (!allResults.length){ alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã'); return; }
      let csv = 'client_code,product,push_notification\n';
      for (const r of allResults){
        const esc = (s)=> String(s).replace(/"/g,'""');
        csv += `${r.client_code},"${esc(r.product)}","${esc(r.push_notification)}"\n`;
      }
      const blob = new Blob(['\ufeff'+csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      const url = URL.createObjectURL(blob);
      a.href = url; a.download = 'push_notifications.csv'; a.style.display='none'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
    window.onload = () => { loadClientsData().catch(e=>{ console.error(e); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å /data/clients.csv'); }); };
  </script>
</body>
</html>